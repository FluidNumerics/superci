steps:
  - name : "Build, Test, and get coverage on Noether"
    sbatch_options: 
      - "--partition=mi210"
      - "--exclusive"
      - "--gpus=1"
      - "-N1"
      - "--time=5:00"
    modules:
      - gcc/11.4.0
      - openmpi/4.1.2
      - cmake
      - hdf5
      - feqparse
      - jsonfortran
    env:
      BUILD_DIR: ${WORKSPACE}/build
      PREFIX: ${WORKSPACE}/opt/self
      OUTDIR: ${WORKSPACE}/local
      BUILD_TYPE: "Coverage"
    commands: 
      - |
        mkdir -p ${WORKSPACE}/build
        cd ${WORKSPACE}/build 
        FC=gfortran \
        FFLAGS="-DDOUBLE_PRECISION" \
        cmake -DCMAKE_PREFIX_PATH=/opt/rocm \
              -DCMAKE_HIP_ARCHITECTURES=${GPU_TARGET} \
              -DCMAKE_INSTALL_PREFIX=${WORKSPACE}/opt/self \
              -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
              ../
        make VERBOSE=1
        make install

        # Initialize coverage
        mkdir -p ${WORKSPACE}/tmp/
        lcov --no-external \
             --capture \
             --initial \
             --directory ${BUILD_DIR} \
             --output-file ${WORKSPACE}/tmp/lcov_base.info

        # Run ctests
        ctest --test-dir ${BUILD_DIR}/build/test
        
        # Capture coverage from ctests
        lcov --no-external \
             --capture \
             --directory ${BUILD_DIR} \
             --output-file ${WORKSPACE}/tmp/lcov_test.info

        # Combine coverage files
        lcov --add-tracefile ${WORKSPACE}/tmp/lcov_base.info \
             --add-tracefile ${WORKSPACE}/tmp/lcov_test.info \ 
             --output-file ${OUTDIR}/lcov.info

config:
  repository: "fluidnumerics/self"
  trigger: "pull_request"
  branch: "main"
  github_access_token_path: "/home/joe/apps/superci/github_pat"
  workspace_root: "/home/joe/.superci/workspace"